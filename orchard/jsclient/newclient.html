<html>
<head>
	<title>Beta replacement client</title>

	<script src="head.js"></script>
	<script>
		var ted, hostws, docs, bcp, wbcp;

		head.js(
			"jquery.js",
			"textile.js",
			"util.js",
			"buffer.js",
			"stream.js",
			"ctree.js",
			"operation.js",
			"bcp.js",
			"view.js")

		head.ready("textile.js",function(){
			//ted = new Textile.Editor('editor');
			wbcp = $("#writebcp");
		})

		head.ready("stream.js",function(){
			// Find port
			wsport = get_url_variable("ws",9091)
			// Start websocket
			hostws = new ws_stream("ws://localhost:"+wsport+"/");
		});

		head.ready("bcp.js",function(){
			function log(source, msg) {
				$('#bcplog').append("<li><b>"+source.toUpperCase()+": </b>"+msg+"</li>")
			}

			// Start BCP processor
			docs = new DocumentHandler();

			bcp = new BCP(docs, hostws, null)
			bcp.log = log;

			function checkJSON(){
				if (isJSON(wbcp.val())) {
					wbcp.addClass("valid")
				} else {
					wbcp.removeClass("valid")
				}
			}
			wbcp.keyup(checkJSON)

			$('#submitbcp').click(function(){
				bcp.send(JSON.parse(wbcp.val()));
				wbcp.val("");
				wbcp.removeClass("valid");
			})

			$('#reconnectbutton').click(function(){
				bcp.reconnect()
			})
		});

		function my_display(){
			this.text = "";
			this.display = $("#display #screen");
			this.buttons = $("#display input:button");
			this.lock = function(){
				this.buttons.attr("disabled", true);
			}
			this.unlock = function(){
				this.buttons.attr("disabled", false);
			}
			this.replace = function(start, end, value){
				this.text = this.text.slice(0,start)+value+this.text.slice(end);
				this.display.html(this.text) // TODO: escape html literals
			}
		}

		var rootview;
		var rootdisplay;
		head.ready("view.js",function(){
			rootview = docs.get("hello")[0]
			rootdisplay = new my_display();
			rootview.display = rootdisplay;
		});

		function easy_insert(){
			var pos = $('.inserter .pos').val();
			var value = $('.inserter .value').val();
			rootdisplay.replace(pos,pos,value);
			rootview.insert(pos, value);
		}

		function easy_delete(){
			var start = int($('.deleter .start').val());
			var end = int($('.deleter .end').val());
			rootdisplay.replace(start,end+1,"");
			rootview.delete(start, end);
		}
	</script>
	<style>
		textarea#writebcp {
			width: 800px;
			background-color: #FAA;
		}

		textarea#writebcp.valid {
			background-color: #AFA;
		}

		input#submitbcp {
			display:block;
		}

		pre {
			border: 2px solid #DDD;
			min-height:5em;
		}
	</style>
</head>
<body>
<p>
<img src="OrchardBigLogo.svg" alt="Orchard Logo"/>
</p>

<!-- <p><canvas id="editor" width="800" height="300"></canvas></p> -->

<div id="display">
	<h1>Docname: "hello"</h1>
	<pre id="screen"></pre>
	<form class="inserter">
		<input type="button" value="Insert" onclick="easy_insert()"/>
		<input type="text" class="pos" value="pos">
		<br/><textarea class="value">Value</textarea>
	</form>
	<hr/>
	<form class="deleter">
		<input type="button" value="Delete" onclick="easy_delete()"/>
		<input type="text" class="start" value="start">
		<input type="text" class="end" value="end">
	</form>
</div>
<div>
BCP log:
<ul id="bcplog">
</ul>
<textarea id="writebcp"></textarea>
<input type="submit" id="submitbcp"/>
<input type="button", value="Reconnect" id="reconnectbutton"/>
</div>

</body>
</html>
