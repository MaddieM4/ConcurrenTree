<html>
<head>
	<title>JS CTree/Textile Example</title>

	<script src="jquery-1.4.2.min.js"></script>
	<script src="textile-editor.min.js"></script>
	<script src="ctree.js"></script>
	<script src="chainer.js"></script>
</head>

<body>

<p>
<img src="OrchardBigLogo.svg" alt="Orchard Logo"/>
</p>

<a href="http://guillaume.bort.fr/textile-editor/index.html">
<h4>Get Textile Editor by Guillame Bort!</h4></a>

<p><canvas id="editor" width="800" height="300"></canvas></p>

<footer>
This is an example of how to use ConcurrenTree technology in
JavaScript/HTML. We're using Textile, a canvas-based text
editor, for its ability to intercept keystrokes - basically
it already has all the generic requirements for a concurrent
text display built in.

<h4>To Do:</h4>
<ul>
	<li>Work out the protocol</li>
	<li>Make a server</li>
	<li>Write an exop processor</li>
	<li><s>Write a better inop processor that chains commands.</s></li>
	<li>Use a DOM-based editor instead of a canvas solution</li>
</ul>
</footer>

<script>
	ted = new Textile.Editor('editor');

	main = new Chainer(new CTree(ted.model.content));

	setInterval(function(){main.apply()}, 1000);

	hadfocus = undefined;
	function lock() {
		if (hadfocus == undefined) {
			hadfocus = ted.hasFocus;
		}
		ted.hasFocus = false;
	}

	function unlock() {
		if (hadfocus != undefined) {
			ted.hasFocus = hadfocus;
		}
		hadfocus = undefined;
	}

	lastcommand = -1;
	function readcommands() {
		lock(); // lock ted
		// read and apply commands
		var com = ted.history.commands;
		for (var i=lastcommand+1; com.length>i; i++) {
			readcommand(com[i]);
		}
		lastcommand = com.length-1;
		unlock();
	}

	function readcommand(com) {
		//console.log(com['at']);
		if (com['type']=="i") {
			// insert single character
			main.flatinsert(com['at'], com['txt']);
		} else if (com['type']=="d"){
			// delete single character
			main.flatdelete(com['at']);
		} else if (com['type']=="r"){
			// replacement
			var sel = com['selection'];
			main.flatreplace(sel['from'],sel['to']-1, com['newTxt']);
		} else {
			console.log("Could not understand command:");
			console.log(com);
		}
		//console.log(main.flatten())
	}

	function pushchange(replacement) {
		lock(); // lock ted
		var content = ted.model.content;
		ted.setContent(content.substr(0,replacement['start'])+replacement['new']+content.substr(replacement['end']));
		unlock();
	}

	setInterval(readcommands, 200)

	function send(ws, obj) {
		ws.send(JSON.stringify(obj)+"\x00");
	}
</script>

</body>
</html>
