<html>
<head>
	<title>JS CTree/Textile Example</title>

	<script src="jquery-1.4.2.min.js"></script>
	<script src="textile-editor.min.js"></script>
	<script src="ctree.js"></script>
</head>

<body>

<a href="http://guillaume.bort.fr/textile-editor/index.html">
<h4>Get Textile Editor by Guillame Bort!</h4></a>

<p><canvas id="editor" width="800" height="300"></canvas></p>

<footer>
This is an example of how to use ConcurrenTree technology in
JavaScript/HTML. We're using Textile, a canvas-based text
editor, for its ability to intercept keystrokes - basically
it already has all the generic requirements for a concurrent
text display built in.
</footer>

<script>
	ted = new Textile.Editor('editor');

	main = new CTree(ted.model.content);

	hadfocus = undefined;
	function lock() {
		if (hadfocus == undefined) {
			hadfocus = ted.hasFocus;
		}
		ted.hasFocus = false;
	}

	function unlock() {
		if (hadfocus != undefined) {
			ted.hasFocus = hadfocus;
		}
		hadfocus = undefined;
	}

	lastcommand = -1;
	function readcommands() {
		lock(); // lock ted
		// read and apply commands
		var com = ted.history.commands;
		for (var i=lastcommand+1; com.length>i; i++) {
			readcommand(com[i]);
		}
		lastcommand = com.length-1;
		unlock();
	}

	function readcommand(com) {
		if (com['type']=="i") {
			// insert
			t = main.trace(com['at']);
			main.resolve(t['address']).insert(t['position'], com['txt']);
		}
		console.log(main.flatten())
	}

	function pushchange(replacement) {
		lock(); // lock ted
		var content = ted.model.content;
		ted.setContent(content.substr(0,replacement['start'])+replacement['new']+content.substr(replacement['end']));
		unlock();
	}

	//setInterval(readcommands, 200)
</script>

</body>
</html>
